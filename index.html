<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Manage Chef Server by vkhatri</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Manage Chef Server</h1>
        <p>Manage Chef Server Environments, Roles, Data Bags and Cookbooks  </p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/vkhatri/chef-repo" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/vkhatri/chef-repo/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/vkhatri/chef-repo/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a name="chef-repo" class="anchor" href="#chef-repo"><span class="octicon octicon-link"></span></a>Chef-Repo</h1>

<p>I has been some time i started working on Opscode Chef. Coming from Puppet background it has been a good experience and learning curve. I think by putting this document together, my little experience could be useful to a newbie like me to start Managing infrastructure using Opscode Chef OSS.</p>

<p><strong>Sections ...</strong></p>

<ul>
<li>Install Chef Server (Open Source)</li>
<li>Install Chef Client</li>
<li>Setup Admin User and Knife (Chef Workstation)</li>
<li>Chef Environments</li>
<li>Chef Roles</li>
<li>Chef Data Bags</li>
<li>Chef Cookbooks / Recipes</li>
<li>Git Version Controlled - Chef Repositories </li>
<li>Rebuild a Chef Server</li>
<li>References</li>
</ul><p><strong>Kickstart ..</strong></p>

<p>If you are new to Configuration Management System, check out below links on Opscode Chef:</p>

<blockquote>
<p><a href="https://wiki.opscode.com/display/chef/Home">https://wiki.opscode.com/display/chef/Home</a></p>

<p><a href="http://docs.opscode.com/">http://docs.opscode.com/</a></p>

<p><a href="http://docs.opscode.com/chef_overview.html">http://docs.opscode.com/chef_overview.html</a></p>
</blockquote>

<p>Chef documentation is very vast and some times it gets very tricky to choose a best way of doing things. Chef supports pure Ruby implementation, which means you can write your own code within Chef DSL.</p>

<p>There are multiple ways of doing a single thing, you can simply put everything in a cookbook using simple ruby program or you could take the benefits of roles/environments/data bags etc to write a cookbook. And if you want to get serious about creating a standard cookbook, check out <a href="http://docs.opscode.com/lwrp_custom_resource.html">Custom LWRP</a> or <a href="http://docs.opscode.com/lwrp_custom_provider_ruby.html">Custom Ruby LWRP</a>. </p>

<p>Its very easy to build Chef resources without following proper standards or enough thinking, i have had this experience in past and it is not easy to go back &amp; set things right. Before you know, it gets out of hands and you have no choice but keep going with the things as they are.</p>

<p>Laying out Chef Environment, Role and Data Bag data attributes properly is very essential to write a proper cookbook in such a way that future addon or resource addition will be easy &amp; could be handled with minimal effort of changing cookbook. It might not be true to every scenario but it sure does help to cover requirements like handling packages management etc. </p>

<p>If you are coming from puppet background, hiera is the first puzzle to sort out in Chef world. You can achieve it at many levels and many ways. </p>

<p>Version Controlling is another important piece when it comes to any Configuration Management System. It is what decides how fast system can recover from disaster or reverted back to last known good state. chef-repo gave a good start point towards version control. Splitting out Chef resources into different git repositories provides even more granular control. There are number of ways you can manage Chef Server via Git, the approach followed in this document is described in section "Git Version Controlled - Chef Repositories". </p>

<blockquote>
<p>This document is an individual approach of managing 
Infrastructure using Opscode Chef (Open Source). 
For Chef complete documentation and reference 
check out <a href="https://wiki.opscode.com/">Chef Wiki</a> and <a href="http://docs.opscode.com/">Chef Docs</a>.</p>
</blockquote>

<h2>
<a name="install-chef-server-open-source" class="anchor" href="#install-chef-server-open-source"><span class="octicon octicon-link"></span></a>Install Chef Server (Open Source)</h2>

<p>Chef Installation is as easy as it can get. Download the Chef server package or follow bash install method by following <a href="http://www.getchef.com/chef/install/">chef install</a>.</p>

<p><strong>Customize Chef Server Details Before Setup</strong></p>

<p>This is something i have not explored yet, may be on next Chef server build.</p>

<p>Details like the Chef server name, using wild card or multiple server alias certificate, domain name etc. are to setup according to infrastructure before Chef server setup. It could be possible to change it after the server setup but it could would affect existing clients.</p>

<p><strong>Running on Amazon</strong></p>

<p>If you are running on amazon platform, you might be prone to runlist error. It might have been fixed by now in later Chef server releases in which case just ignore below section otherwise update file '/opt/chef-server/embedded/cookbooks/runit/recipes/default.rb' as a workaround.</p>

<div class="highlight highlight-sh"><pre><span class="c"># diff -u /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb.old /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb</span>

--- /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb.orig    2014-01-26 20:00:26.123165937 +0000
+++ /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb.new    2014-01-26 20:03:22.030175179 +0000
@@ -29,6 +29,8 @@
   end
 when <span class="s2">"xenserver"</span>
   include_recipe <span class="s2">"runit::upstart"</span>
+when <span class="s2">"amazon"</span>
+  include_recipe <span class="s2">"runit::upstart"</span>
 <span class="k">else</span>
<span class="k">   </span>include_recipe <span class="s2">"runit::sysvinit"</span>
 end
</pre></div>

<p>Browse https://chef_server_dns and change the default admin password. Create admin client/user for different users to setup Chef Workstation.</p>

<p>For more information read <a href="http://docs.opscode.com/config_rb_chef_server.html">chef server config</a>.</p>

<h2>
<a name="install-chef-client" class="anchor" href="#install-chef-client"><span class="octicon octicon-link"></span></a>Install Chef Client</h2>

<p>Just like server, download Chef Client package or follow typical method of bash install by following <a href="http://www.getchef.com/chef/install/">chef install</a>.</p>

<p>Once Chef client package is installed, create below files to bootstrap Chef client.</p>

<p><strong>Chef Client Directories</strong></p>

<div class="highlight highlight-sh"><pre><span class="c"># Create Chef Client Directories</span>
<span class="c">#</span>
mkdir /etc/chef
mkdir /etc/chef/ohai
mkdir /etc/chef/ohai/plugins
mkdir /etc/chef/ohai/hints
</pre></div>

<div class="highlight highlight-sh"><pre><span class="c"># File: /etc/chef/chef-validator.pem</span>
<span class="c"># Copy the content of chef-validator.pem file</span>
<span class="c"># content from server. Once chef-client </span>
<span class="c"># gets registered with Chef server this file is</span>
<span class="c"># no longer required and must be removed.</span>
</pre></div>

<p><strong>Chef Client Config file</strong></p>

<div class="highlight highlight-sh"><pre><span class="c"># File: /etc/chef/client.rb</span>
<span class="c"># Create Chef Client Config file, below is </span>
<span class="c"># the minimal configuration to kick start </span>
<span class="c"># the client. You can modify it according</span>
<span class="c"># to your requirement</span>


<span class="c"># Server Configuration</span>
chef_server_url  <span class="s2">"https://{chef server url}/"</span>
environment <span class="s2">"{environment name}"</span>
validation_client_name <span class="s2">"chef-validator"</span>
validation_key <span class="s2">"/etc/chef-server/chef-validator.pem"</span>


<span class="c"># Client Configuration</span>
node_name <span class="s2">"{chef client fqdn}"</span>
client_key <span class="s2">"/etc/chef/client.pem"</span>
client_registration_retries 3
json_attribs <span class="s2">"/etc/chef/client-config.json"</span>

<span class="c"># Timeout</span>
splay 30
interval 1800
rest_timeout 300

<span class="c"># Options</span>
diff_disabled <span class="nb">true</span>
enable_reporting <span class="nb">false</span>
enable_selinux_file_permission_fixup <span class="nb">false</span>
file_atomic_update <span class="nb">true</span>
user nil
group nil

<span class="c"># Logging</span>
verbose_logging <span class="nb">false</span>
log_level :info
log_location STDOUT
<span class="c"># To Forward logs to a file:</span>
<span class="c"># log_location '/var/log/chef/chef-client.rb'</span>

Ohai::Config<span class="o">[</span>:plugin_path<span class="o">]</span> &lt;&lt; <span class="s1">'/etc/chef/ohai/plugins'</span>

Dir.glob<span class="o">(</span>File.join<span class="o">(</span><span class="s2">"/etc/chef"</span>, <span class="s2">"client.d"</span>, <span class="s2">"*.rb"</span><span class="o">))</span>.each <span class="k">do</span> <span class="p">|</span>conf<span class="p">|</span>
  Chef::Config.from_file<span class="o">(</span>conf<span class="o">)</span>
end
</pre></div>

<p>For more information read <a href="http://docs.opscode.com/config_rb_client.html.">client config</a> or checkout <a href="https://github.com/opscode-cookbooks/chef-client">chef-client</a> cookbook.</p>

<p><strong>Node Custom Attributes or run_list</strong></p>

<p>Node <em>run_list</em> or <em>client attributes</em> can be defined in "/etc/chef/client-config.json" file. </p>

<p>Note that these variables will override any other variable defined in Cookbooks or Role, useful for first boot.</p>

<p>Ideally use knife or Chef Console to assign roles/recipes to a node.</p>

<div class="highlight highlight-sh"><pre><span class="c"># cat /etc/chef/client-config.json</span>

<span class="o">{</span>
  <span class="s2">"run_list"</span>: <span class="o">[</span>
    <span class="s2">"role[common_role]"</span>,
    <span class="s2">"role[application_role]"</span>,
    <span class="s2">"recipe[some_recipe]"</span>,
    <span class="s2">"recipe[some_recipe]"</span>,
    <span class="s2">"..etc"</span>
    <span class="o">]</span>,
    <span class="s2">"application"</span>: <span class="s2">"webserver"</span>
<span class="o">}</span>
</pre></div>

<p>You can also define node attributes via Ohai by creating your own Ohai Plugins. </p>

<p>Ohai plugins are ruby code where you can put your logic to create custom node attributes according to your environment.</p>

<p>e.g. File "/etc/chef/client.rb" has an entry:
"Ohai::Config[:plugin_path] &lt;&lt; '/etc/chef/ohai/plugins'" </p>

<p>which tell Ohai to include plugins from location '/etc/chef/ohai/plugins' on Chef client run.</p>

<div class="highlight highlight-sh"><pre><span class="c"># cat /etc/chef/ohai/plugins/application.rb</span>
provides <span class="s2">"application"</span>
application <span class="s2">"webserver"</span>
</pre></div>

<p>If you are running on Amazon platform, ec2 hint must be present to load Ohai ec2 metadata.</p>

<div class="highlight highlight-sh"><pre><span class="nb">echo</span> <span class="s1">'{}'</span> &gt; /etc/chef/ohai/hints/ec2.json
</pre></div>

<p>For more info read <a href="http://docs.opscode.com/ohai.html">ohai</a>.</p>

<p>For Ohai plugins <a href="http://docs.opscode.com/ohai_custom.html">ohai custom</a>.</p>

<h2>
<a name="setup-admin-user-and-knife-chef-workstation" class="anchor" href="#setup-admin-user-and-knife-chef-workstation"><span class="octicon octicon-link"></span></a>Setup Admin User and Knife (Chef Workstation)</h2>

<p>Knife is a Chef Management Utility. It is a set of Chef API calls and plugins to manage Chef Server. Knife can manage Chef roles, environments, data bags, cookbooks, run list, nodes and clients etc. There are some other powerful utilities available to perform same work like Berkshelf etc.</p>

<p>To setup a Knife Client or Workstation, user require client or user private key with admin privilege. It can be created from  Chef Console by following web document <a href="http://docs.opscode.com/chef/manage_server_open_source.html">manage auth</a>.</p>

<p>For more information on Knife refer to <a href="http://docs.opscode.com/knife.html">knife</a>.</p>

<p><strong>Knife Setup</strong></p>

<p>Create directory '~/.chef' and create knife.rb file.</p>

<div class="highlight highlight-sh"><pre>mkdir ~/.chef
touch ~/.chef/knife.rb
</pre></div>

<div class="highlight highlight-sh"><pre><span class="c"># cat ~/.chef/knife.rb</span>

log_level                :info
log_location             STDOUT
node_name                <span class="s1">'foo'</span>
client_key               <span class="s1">'~/.chef/foo.pem'</span>
validation_client_name   <span class="s1">'foo'</span>
validation_key           <span class="s1">'~/.chef/foo.pem'</span>
chef_server_url          <span class="s1">'https://&lt;chef server url&gt;'</span>
syntax_check_cache_path  <span class="s1">'~/.chef/syntax_check_cache'</span>
cookbook_path            <span class="s1">'~/chef-repo/cookbooks'</span>
environment_path         <span class="s1">'~/chef-repo/environments'</span>
data_bag_path            <span class="s1">'~/chef-repo/data_bags'</span>
role_path                <span class="s1">'~/chef-repo/chef_roles'</span>
cookbook_copyright       <span class="s1">'foo'</span>
cookbook_license         <span class="s1">'apachev2'</span>
cookbook_email           <span class="s1">'foo@foo.com'</span>
</pre></div>

<p>For more knife.rb options <a href="http://docs.opscode.com/config_rb_knife.html">knife config</a>.</p>

<p><strong>Test knife client</strong></p>

<div class="highlight highlight-sh"><pre><span class="c"># knife client list</span>
chef-validator
chef-webui
webserver
...
</pre></div>

<p>Now you have a Chef Workstation from where you can create/delete/modify Chef resources. Different team members can have their own client/user id to manage different chef resources.</p>

<h2>
<a name="chef-environments" class="anchor" href="#chef-environments"><span class="octicon octicon-link"></span></a>Chef Environments</h2>

<p>Environment concept in Chef is very simple:</p>

<ul>
<li>environment is a simple json file or a chef dsl .rb file</li>
<li>useful to define default or override attributes global to roles or specific to an attribute</li>
<li>primary use of an environment is to define cookbooks version, Chef can have more than one version of cookbooks, you can map a cookbook version to an environment </li>
<li>chef default environment is _default. Unless an environment is declared in /etc/chef/client.rb or in Chef Console for a node, node by default is configured with _default environment.</li>
<li>you can create 'n' numbers of environments</li>
</ul><p>For more information on environment read <a href="http://docs.opscode.com/essentials_environments.html">essentials environments</a>.</p>

<p>If you have multiple environments like production, stage or qa, it is always better to bootstrap the node with the respective environment instead of _default environment.</p>

<p><strong>How to Create an Environment</strong></p>

<p>Creating an environment using knife:</p>

<div class="highlight highlight-sh"><pre><span class="c"># knife environment create production</span>

<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"production"</span>,
  <span class="s2">"description"</span>: <span class="s2">"Production Environment"</span>,
  <span class="s2">"cookbook_versions"</span>: <span class="o">{</span>
    <span class="s2">"cookbook_name"</span>: <span class="s2">"= 0.1.0"</span>
  <span class="o">}</span>,
  <span class="s2">"json_class"</span>: <span class="s2">"Chef::Environment"</span>,
  <span class="s2">"chef_type"</span>: <span class="s2">"environment"</span>,
  <span class="s2">"default_attributes"</span>: <span class="o">{</span>
    <span class="s2">"some_default_variable"</span>: <span class="o">{}</span>
  <span class="o">}</span>,
  <span class="s2">"override_attributes"</span>: <span class="o">{</span>
    <span class="s2">"some_variable_to_override"</span>: <span class="o">{}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>This will open up editor with default attributes. For git version controlled or to edit it manually store the content into environment.json file. Later you can modify it locally without using knife or use it to create more environments. </p>

<p>Better approach is to store environment.json file into a git repo. </p>

<p>Whenever making any changes to environment.json file, commit it to git prior to Chef upload using knife.</p>

<div class="highlight highlight-sh"><pre>knife environment from file environment.json
</pre></div>

<p><strong>Where to Use Environment JSON attributes</strong></p>

<p>Environment is useful to define cookbooks version, environment global attributes and override roles attributes. You can have multipe cookbook versions uploaded to Chef Server and can choose which version you want to run in an environment.</p>

<ul>
<li><p>environment JSON file must be kept simple, other than overriding roles attributes or global roles/cookbooks attributes try to use roles/cookbooks instead of environment</p></li>
<li><p>environment.json file can have attributes differs between environment, like to test new java_version, development environment can have newer version for testing, while production still running on older version</p></li>
<li><p>If environments shares list of common attributes, create a common role with those attributes and add it to each environment for other roles.</p></li>
<li><p>If you have different roles with some common attributes and you want to override some of them, use environment to override.</p></li>
</ul><p>Attribute value is just the precedence of default &amp; override attributes spreaded acrossed cookbooks, roles and environment. But it could get complex and out of hand if not defined properly.</p>

<p><strong>Where Not to Use Environment JSON attributes</strong></p>

<p>This is something that can be learnt over time, but try to avoid environment for any attributes declaration unless have to.</p>

<p><strong>Environment with a Common Role - role[system]</strong></p>

<p>A Common role is a simplified approach to manage common attributes, run_list for cookbooks, other roles and environments.</p>

<p>Lets create a common role 'role[system]' to store all global attributes, recipe and run_list which can be attached to other roles.</p>

<p>Any attribute you want to declare across environments, roles or cookbooks can be defined in this common e.g. common packages, services, attributes, run_list etc.</p>

<h2>
<a name="chef-roles" class="anchor" href="#chef-roles"><span class="octicon octicon-link"></span></a>Chef Roles</h2>

<p>Chef Role is a collection of attributes and run_list of roles/recipes. It is more like an application type which knows what variables needs to be declared and which recipes/roles needs to run for that application.</p>

<p>In a role each environment can have different run_list of roles/recipes.</p>

<ul>
<li>role is a simple json file or chef dsl .rb file</li>
<li>role is used to define environment specific run_list</li>
<li>role can store attributes required for recipes</li>
</ul><p>For more information on <a href="http://docs.opscode.com/essentials_roles.html">essentials roles</a>.</p>

<div class="highlight highlight-sh"><pre><span class="c"># cat jump.json</span>

<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"jump"</span>,
  <span class="s2">"description"</span>: <span class="s2">"Jump / SSH Login Gateway Server"</span>,
  <span class="s2">"json_class"</span>: <span class="s2">"Chef::Role"</span>,
  <span class="s2">"default_attributes"</span>: <span class="o">{</span>
    <span class="s2">"groups"</span>: <span class="o">{</span>
      <span class="s2">"dev"</span>: <span class="o">{}</span>
    <span class="o">}</span>,
    <span class="s2">"packages"</span>: <span class="o">{</span>
      <span class="s2">"debian"</span>: <span class="o">{}</span>,
      <span class="s2">"rhel"</span>: <span class="o">{}</span>
    <span class="o">}</span>,
    <span class="s2">"services"</span>: <span class="o">{</span>
      <span class="s2">"rhel"</span>: <span class="o">{}</span>,
      <span class="s2">"debian"</span>: <span class="o">{}</span>
    <span class="o">}</span>
  <span class="o">}</span>,
  <span class="s2">"override_attributes"</span>: <span class="o">{}</span>,
  <span class="s2">"chef_type"</span>: <span class="s2">"role"</span>,
  <span class="s2">"run_list"</span>: <span class="o">[]</span>,
  <span class="s2">"env_run_lists"</span>: <span class="o">{</span>
    <span class="s2">"production"</span>: <span class="o">[</span>
      <span class="s2">"recipe[sshd]"</span>,
      <span class="s2">"role[system]"</span>
    <span class="o">]</span>,
    <span class="s2">"development"</span>: <span class="o">[</span>
      <span class="s2">"recipe[sshd]"</span>,
      <span class="s2">"role[system]"</span>,
      <span class="s2">"role[dev_recipe]"</span>
    <span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p><strong>Common Role - role[system] for all Environments/Nodes</strong></p>

<p>role[system] is a role i found very useful to use with each role or run_list of a node. </p>

<p>It is a default role which has all the minimum packages, services, users, file or any other resource declaration which must be setup to every node regardless of environment.</p>

<p>Just adding role[system] to run_list of other role or node we will have our common base setup across the environments nodes.</p>

<p><strong>Create a Role</strong></p>

<p>To create a role you can use blow knife command:</p>

<div class="highlight highlight-sh"><pre>knife role create &lt;role name&gt;
</pre></div>

<p>You can also create a .json or .rb file manually or copy from an existing one. By Creating role.json files, they can be stored in a git repo. Like environments json file we can use git to have version controlled on roles json files.</p>

<p>Once a role json file is created, use knife to upload to Chef server:</p>

<div class="highlight highlight-sh"><pre>knife role from file role.json
</pre></div>

<h2>
<a name="chef-data-bags" class="anchor" href="#chef-data-bags"><span class="octicon octicon-link"></span></a>Chef Data Bags</h2>

<p>Chef Data Bags are immutable JSON Data Stores globally available for cookbooks. They are useful to store static data information or attributes, e.g. use/group/keys information. Data Bags supports encryption to store data bag json file in encrypted format.</p>

<p>For more information read out <a href="http://docs.opscode.com/essentials_data_bags.html">essentials data bags</a>.</p>

<p><strong>Create Data Bag</strong></p>

<p>A Data Bag or Data Bag Item can be created usin knife:</p>

<div class="highlight highlight-sh"><pre>knife data bag create &lt;data bag name&gt;
knife data bag create &lt;data bag name&gt; &lt;data bag item&gt;
</pre></div>

<p>Data bag json file can also be created manually. As Data Bags are json files they can easily be maintained in git.</p>

<p>To upload Data Bag item directly from a json file:</p>

<div class="highlight highlight-sh"><pre>knife data bag from file &lt;data bag name&gt; &lt;data bag item&gt;.json
</pre></div>

<p>Now the data bags are directories in git repo with different data bag item json files in it.</p>

<h2>
<a name="chef-cookbooks--recipes" class="anchor" href="#chef-cookbooks--recipes"><span class="octicon octicon-link"></span></a>Chef Cookbooks / Recipes</h2>

<p>Cookbook is collection of recipes, attributes, templates etc. Cookbook is like Chef Ruby module to declare resources.</p>

<p><strong>Create a Cookbook</strong></p>

<div class="highlight highlight-sh"><pre><span class="c"># knife cookbook create -o . sample_cookbook</span>
** Creating cookbook sample_cookbook
** Creating README <span class="k">for </span>cookbook: sample_cookbook
** Creating CHANGELOG <span class="k">for </span>cookbook: sample_cookbook
** Creating metadata <span class="k">for </span>cookbook: sample_cookbook
</pre></div>

<p>For detail documentation refer to <a href="http://docs.opscode.com/essentials_cookbooks.html">chef cookbooks</a>.</p>

<h2>
<a name="git-version-controlled---chef-repositories" class="anchor" href="#git-version-controlled---chef-repositories"><span class="octicon octicon-link"></span></a>Git Version Controlled - Chef Repositories</h2>

<p>Version Control is quite a different approach between Puppet and Chef. From my short experience Chef server can only be managed via tools like knife or via Console.</p>

<p>We can version control Chef by version controlling Chef resources.</p>

<p>Instead of maintaing a single chef-repo repository, we can split chef-repo into different repositories:</p>

<ul>
<li>chef_data_bags - This repository has all Chef Data Bags and Items files</li>
<li>chef_roles - This repository consists all the Chef roles json or .rb files</li>
<li>chef_environments - This repository consists all Chef environments json or .rb files</li>
<li>
<p>chef_cookbooks - This repository is categorized into three sub categories. Thanks to <a href="http://leknarf.net/blog/2013/04/22/staying-sane-while-writing-chef-cookbooks/#.UujOp_a6Zcx">Leknarf</a> post which made it easy to manage cookbooks structure.</p>

<ul>
<li>vendor_cookbooks - Store all public site downloaded cookbooks here</li>
<li>public_cookbooks - Store In-house written cookbooks here which can be shared via github or opscode or public website, they are like vendor cookbooks but developed in-house</li>
<li>private_cookbooks - Store all in-house cookbooks here which can not be shared with public</li>
</ul>
</li>
<li><p>chef_distribution - Stores any static files or small binaries files here</p></li>
</ul><p>Git access can be privileged per repository for different environment using <a href="http://www.linuxforu.com/2011/01/gitolite-specify-complex-access-controls-git-server/">git acl</a>.</p>

<p><strong>Create a New Chef Role using git</strong></p>

<p>Checkout chef_roles repository:</p>

<div class="highlight highlight-sh"><pre>git clone git@GIT_SERVER:chef_roles
<span class="nb">cd </span>chef_roles
ls
    jenkins.json    jump.json system.json
</pre></div>

<p>Create New role file using knife or simply copy an existing role:</p>

<div class="highlight highlight-sh"><pre>cp jenkins.json new_role.json
</pre></div>

<p>Modify the new role id, description, attributes etc.</p>

<div class="highlight highlight-sh"><pre><span class="c"># cat new_role.json</span>
<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"new_role"</span>,
  <span class="s2">"description"</span>: <span class="s2">"New Role Description"</span>,
  <span class="s2">"json_class"</span>: <span class="s2">"Chef::Role"</span>,
  <span class="s2">"default_attributes"</span>: <span class="o">{}</span>,
  <span class="s2">"override_attributes"</span>: <span class="o">{}</span>,
  <span class="s2">"chef_type"</span>: <span class="s2">"role"</span>,
  <span class="s2">"run_list"</span>: <span class="o">[]</span>,
  <span class="s2">"env_run_lists"</span>: <span class="o">{</span>
    <span class="s2">"production"</span>: <span class="o">[</span>
    <span class="o">]</span>,
    <span class="s2">"development"</span>: <span class="o">[</span>
    <span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>Once created, it is always better to validate JSON syntax using a json parser. This could also be set to default in git pre-hook.</p>

<p>Push the new role to git</p>

<div class="highlight highlight-sh"><pre>git add new_roles.json
git commit -m <span class="s2">"added new_role"</span>
git push
</pre></div>

<p>Upload new_role to Chef using knife</p>

<div class="highlight highlight-sh"><pre>knife role from file new_role.json
</pre></div>

<p>And finally you can test the new role. </p>

<h2>
<a name="rebuild-a-chef-server" class="anchor" href="#rebuild-a-chef-server"><span class="octicon octicon-link"></span></a>Rebuild a Chef Server</h2>

<p>Rebuilding a Chef Server steps are similar to steps in "Install Chef Server" section. </p>

<p>But the difference in rebuilding an existing server or adding more Chef servers is that we do not need to re-create all the cookbooks, roles, environments or data bags. We can simply use git repositories to upload resources to new Chef server.</p>

<p>There are few components which needs to backup regularly like Chef Server SSL Certificate bundle, Client Signed SSL Certificate Bundles etc. For this purpose one can use individual scripts to take backup of individual components or simple run backup/snapshot of whole Chef Server disk useful for disaster recovery.</p>

<p>There could be other things still remains un-explored for rebuilding a chef server, but it is a good start point to begin with.</p>

<h2>
<a name="references" class="anchor" href="#references"><span class="octicon octicon-link"></span></a>References:</h2>

<p><a href="https://wiki.opscode.com/">https://wiki.opscode.com/</a></p>

<p><a href="http://docs.opscode.com/">http://docs.opscode.com/</a></p>

<p><a href="http://www.slideshare.net/opscode/">http://www.slideshare.net/opscode/</a></p>

<p><a href="http://leknarf.net/blog/2013/04/22/staying-sane-while-writing-chef-cookbooks/#.Us5JZ_a9aT4">http://leknarf.net/blog/2013/04/22/staying-sane-while-writing-chef-cookbooks/#.Us5JZ_a9aT4</a></p>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>Apache v2.0</p>

<p><strong>Open Source!</strong></p>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/vkhatri">vkhatri</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>