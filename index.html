<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Chef-repo by vkhatri</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/vkhatri/chef-repo">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/vkhatri/chef-repo/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/vkhatri/chef-repo/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Chef-repo</h1>
          <p>Chef Environment, Roles, Data Bags and Cookbooks Repositories </p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/vkhatri">vkhatri</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <h1>
<a name="chef-repo" class="anchor" href="#chef-repo"><span class="octicon octicon-link"></span></a>Chef-Repo</h1>

<p>I just recently started with Chef few weeks back and coming from Puppet background i had quite a good amount of Chef experience and learning curve, which i wanted to share with you folks.</p>

<p><strong>Sections ...</strong></p>

<ul>
<li>Install Chef Server</li>
<li>Install Chef Client</li>
<li>Setup Adming User and Knife (Chef Workstation)</li>
<li>Chef Environments</li>
<li>Chef Roles</li>
<li>Chef Data Bags</li>
<li>Chef Cookbooks</li>
<li>Git Version Controlled - Chef Repositories </li>
<li>My Environments, Roles, Data Bags and Cookbooks</li>
</ul><p><strong>Kickstart ..</strong></p>

<p>It took me around two-to-three weeks to understand Chef architecture and start writing cookbooks with multiple environments and couple of application roles.</p>

<p>Coming from puppet background hiera was the first puzzle to figure out in Chef world. And believe me once you understand Chef Environment, Role and Data Bag, it is just matter of time to get this going.</p>

<p>Version Controlling was the only thing that was missing. chef-repo gave quite an idea to split Chef resources into its own git repository. There are number of ways you can manage Chef server Evironment, Role, Data Bags and Cookbooks  via Git. </p>

<p>To keep it simple with a fine access control it seems a good idea to have different git repositories instead of a single chef-repo.  </p>

<p>This could be a turorial for <em>newbie's</em> like <em>me</em> to start with Chef Installation towards Managing different Environments, Application Roles and multi version Cookbooks.</p>

<h2>
<a name="install-chef-server-open-source" class="anchor" href="#install-chef-server-open-source"><span class="octicon octicon-link"></span></a>Install Chef Server (Open Source)</h2>

<p>Chef Instllation is as easy it can get, download the rpm or deb package or just follow typical method of bash install by following - <a href="http://www.getchef.com/chef/install/">http://www.getchef.com/chef/install/</a>.</p>

<p><strong>Customize Chef Server Details Before Setup</strong></p>

<p>This is something i am yet to explore on next Chef server build.</p>

<p>Details like the Chef server name, using wild card or multiple server alias certificate, domain name etc. needs to be specified before Chef server setup or it could be defined after the server setup but it should would affect existing registed clients after generating Chef Server SSL certificate bundle.</p>

<p><strong>Running on Amazon</strong></p>

<p>If you are running on amazon platform, you might be prune to runlist error. It may have been fixed by now in which just ignore below section otherwise you need to update file '/opt/chef-server/embedded/cookbooks/runit/recipes/default.rb' for a workaround.</p>

<div class="highlight highlight-sh"><pre><span class="c"># diff -u /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb.old /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb</span>

--- /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb.orig    2014-01-26 20:00:26.123165937 +0000
+++ /opt/chef-server/embedded/cookbooks/runit/recipes/default.rb.new    2014-01-26 20:03:22.030175179 +0000
@@ -29,6 +29,8 @@
   end
 when <span class="s2">"xenserver"</span>
   include_recipe <span class="s2">"runit::upstart"</span>
+when <span class="s2">"amazon"</span>
+  include_recipe <span class="s2">"runit::upstart"</span>
 <span class="k">else</span>
<span class="k">   </span>include_recipe <span class="s2">"runit::sysvinit"</span>
 end
</pre></div>

<p>Browse https://chef_server_dns and change the default admin password. Create admin client / user for different users if required.</p>

<p>For more information read <a href="http://docs.opscode.com/config_rb_chef_server.html">http://docs.opscode.com/config_rb_chef_server.html</a>.</p>

<h2>
<a name="install-chef-client" class="anchor" href="#install-chef-client"><span class="octicon octicon-link"></span></a>Install Chef Client</h2>

<p>Just like server, download the rpm or deb package or just follow typical method of bash install by following - <a href="http://www.getchef.com/chef/install/">http://www.getchef.com/chef/install/</a>.</p>

<p>Once Chef client package is installed, need to create some files and folders to bootstrap the chef client.</p>

<p><strong>Chef Client Directories</strong></p>

<div class="highlight highlight-sh"><pre><span class="c"># Create Chef Client Directories</span>
<span class="c">#</span>
mkdir /etc/chef
mkdir /etc/chef/ohai
mkdir /etc/chef/ohai/plugins
mkdir /etc/chef/ohai/hints
</pre></div>

<div class="highlight highlight-sh"><pre><span class="c"># File: /etc/chef/chef-validator.pem</span>
<span class="c"># Copy the content of chef-validator.pem file content from server</span>
<span class="c"># Once chef-client gets registered with Chef server this file can be removed, a good practice is to remove this file.</span>
</pre></div>

<p><strong>Chef Client Config file</strong></p>

<div class="highlight highlight-sh"><pre><span class="c"># File: /etc/chef/client.rb</span>
<span class="c"># Create Chef Client Config file, below is the minimal configuration to kick start the client. You can modify it according to your requirement</span>


<span class="c"># Server Configuration</span>
chef_server_url  <span class="s2">"https://{chef server url}/"</span>
environment <span class="s2">"{environment name}"</span>
validation_client_name <span class="s2">"chef-validator"</span>
validation_key <span class="s2">"/etc/chef-server/chef-validator.pem"</span>


<span class="c"># Client Configuration</span>
node_name <span class="s2">"{chef client fqdn}"</span>
client_key <span class="s2">"/etc/chef/client.pem"</span>
client_registration_retries 3
json_attribs <span class="s2">"/etc/chef/client-config.json"</span>

<span class="c"># Timeout</span>
splay 30
interval 1800
rest_timeout 300

<span class="c"># Options</span>
diff_disabled <span class="nb">true</span>
enable_reporting <span class="nb">false</span>
enable_selinux_file_permission_fixup <span class="nb">false</span>
file_atomic_update <span class="nb">true</span>
user nil
group nil

<span class="c"># Logging</span>
verbose_logging <span class="nb">false</span>
log_level :info
log_location STDOUT

Ohai::Config<span class="o">[</span>:plugin_path<span class="o">]</span> &lt;&lt; <span class="s1">'/etc/chef/ohai/plugins'</span>

</pre></div>

<p>For more information read <a href="http://docs.opscode.com/config_rb_client.html">http://docs.opscode.com/config_rb_client.html</a>.</p>

<p><strong>Node Custom Attributes or run_list</strong></p>

<p>Node <em>run_list</em> and <em>custom attributes</em> like application or cluster_name etc. node specific attributes can be defined in "/etc/chef/client-config.json" file. </p>

<p>Note that these variables will override any other variable defined in Cookbooks or Role. You also could use knife or Chef Console to assign roles/recipes to a node.</p>

<div class="highlight highlight-sh"><pre><span class="c"># cat /etc/chef/client-config.json</span>

<span class="o">{</span>
  <span class="s2">"run_list"</span>: <span class="o">[</span>
    <span class="s2">"role[common_role]"</span>,
    <span class="s2">"role[application_role]"</span>,
    <span class="s2">"recipe[some_recipe]"</span>,
    <span class="s2">"recipe[some_recipe]"</span>,
    <span class="s2">"..etc"</span>
    <span class="o">]</span>,
    <span class="s2">"application"</span>: <span class="s2">"webserver"</span>
<span class="o">}</span>
</pre></div>

<p>You can also defined node attributes via Ohai by creating your own Ohai Plugins. Ohai plugin us ruby code which can have any customized custom to fetch and declare attributes according to an environment. e.g. "Ohai::Config[:plugin_path] &lt;&lt; '/etc/chef/ohai/plugins'" in "/etc/chef/client.rb" will tell Ohai to include plugins from location '/etc/chef/ohai/plugins'.</p>

<div class="highlight highlight-sh"><pre><span class="c"># cat /etc/chef/ohai/plugins/application.rb</span>
provides <span class="s2">"application"</span>
application <span class="s2">"webserver"</span>
</pre></div>

<p>If you are running on Amazon platform, ec2 hint is to be created to load Ohai ec2 metadata plugin.</p>

<div class="highlight highlight-sh"><pre><span class="nb">echo</span> <span class="s1">'{}'</span> &gt; /etc/chef/ohai/hints/ec2.json
</pre></div>

<p>For more info on Ohai "<a href="http://docs.opscode.com/ohai.html">http://docs.opscode.com/ohai.html</a>".</p>

<p>For Ohai plugins  "<a href="http://docs.opscode.com/ohai_custom.html">http://docs.opscode.com/ohai_custom.html</a>".</p>

<h2>
<a name="setup-admin-user-and-knife-chef-workstation" class="anchor" href="#setup-admin-user-and-knife-chef-workstation"><span class="octicon octicon-link"></span></a>Setup Admin User and Knife (Chef Workstation)</h2>

<p>Knife is a Chef Management Utilit, it has set of api calls and different plugins to manage Chef Server roles, environments, data bags, cookbooks, run list, node and client etc. Basically knife is a single utility proven to be enough to manage the Chef sever. There are some other powerful utilities too like Berkshelf to do the same thing, choice is yours!</p>

<p>To setup a knife client, create your admin client or user key via Chef Console by following steps in "<a href="http://docs.opscode.com/chef/manage_server_open_source.html">http://docs.opscode.com/chef/manage_server_open_source.html</a>".</p>

<p>Download the private key, this key is required to setup knife client or  Chef Workstation.</p>

<p>For more information on Knife "<a href="http://docs.opscode.com/knife.html">http://docs.opscode.com/knife.html</a>".</p>

<p><strong>Knife Setup</strong></p>

<p>Create directory '~/.chef' and create knife.rb file.</p>

<div class="highlight highlight-sh"><pre>mkdir ~/.chef
touch ~/.chef/knife.rb
</pre></div>

<div class="highlight highlight-sh"><pre><span class="c"># cat ~/.chef/knife.rb</span>

log_level                :info
log_location             STDOUT
node_name                <span class="s1">'foo'</span>
client_key               <span class="s1">'~/.chef/foo.pem'</span>
validation_client_name   <span class="s1">'foo'</span>
validation_key           <span class="s1">'~/.chef/foo.pem'</span>
chef_server_url          <span class="s1">'https://&lt;chef server url&gt;'</span>
syntax_check_cache_path  <span class="s1">'~/.chef/syntax_check_cache'</span>
cookbook_path            <span class="s1">'~/chef-repo/cookbooks'</span>
environment_path         <span class="s1">'~/chef-repo/environments'</span>
data_bag_path            <span class="s1">'~/chef-repo/data_bags'</span>
role_path                <span class="s1">'~/chef-repo/chef_roles'</span>
cookbook_copyright       <span class="s1">'foo'</span>
cookbook_license         <span class="s1">'apachev2'</span>
cookbook_email           <span class="s1">'foo@foo.com'</span>
</pre></div>

<p>For more knife.rb options "<a href="http://docs.opscode.com/config_rb_knife.html">http://docs.opscode.com/config_rb_knife.html</a>".</p>

<p><strong>Test knife client</strong></p>

<div class="highlight highlight-sh"><pre><span class="c"># knife client list</span>
chef-validator
chef-webui
webserver
...
</pre></div>

<p>Now you have a Chef Workstation from where you can create/delete/modify Chef resources. Different team members can have their own client/user id to manage different chef resources.</p>

<h2>
<a name="chef-environments" class="anchor" href="#chef-environments"><span class="octicon octicon-link"></span></a>Chef Environments</h2>

<p>Environment concept in Chef is very simple:</p>

<ul>
<li>environment is a simple json file or a chef dsl .rb file</li>
<li>useful to define default or override attributes</li>
<li>primary usage is to have specific version of cookbook mapped to an environment, as there can be many version of cookbook, you can map a cookbook verion to an environment </li>
<li>chef default environment is _default. Unless an environment is declared in /etc/chef/client.rb or in Chef Console for a node, node by default is configured with _default environment.</li>
<li>you can create 'n' numbers of environments</li>
</ul><p>For more information on environment read out "<a href="http://docs.opscode.com/essentials_environments.html">http://docs.opscode.com/essentials_environments.html</a>".</p>

<p>If you have multiple environments likfe production, stage or qa, it is always better to bootstrap the node with the respective environment instead of _default environment.</p>

<p><strong>How to Create an Environment</strong></p>

<p>Creating an environment is easy by using knife:</p>

<div class="highlight highlight-sh"><pre><span class="c"># knife environment create production</span>

<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"production"</span>,
  <span class="s2">"description"</span>: <span class="s2">"Production Environment"</span>,
  <span class="s2">"cookbook_versions"</span>: <span class="o">{</span>
    <span class="s2">"cookbook_name"</span>: <span class="s2">"= 0.1.0"</span>
  <span class="o">}</span>,
  <span class="s2">"json_class"</span>: <span class="s2">"Chef::Environment"</span>,
  <span class="s2">"chef_type"</span>: <span class="s2">"environment"</span>,
  <span class="s2">"default_attributes"</span>: <span class="o">{</span>
    <span class="s2">"some_default_variable"</span>: <span class="o">{}</span>
  <span class="o">}</span>,
  <span class="s2">"override_attributes"</span>: <span class="o">{</span>
    <span class="s2">"some_variable_to_override"</span>: <span class="o">{}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>Create an environment.json file for the first time using knife command and later you can modify it locally without using knife or use it to create more environments. </p>

<p>This way you can maintain your environment json file into a git repo. Whenever needs to change push it to git prior to knife chef push. </p>

<p>After making a change to an environment,json file, upload it to Chef using knife:</p>

<div class="highlight highlight-sh"><pre>knife environment from file environment.json
</pre></div>

<p><strong>Where to Use Environment JSON attributes</strong></p>

<p>Environment is not an easy place to define attributes. It will get out of hand before you know it.</p>

<p>Environment is useful to define cookbooks version. You can have multipe cookbook versions uploaded to Chef Server. You may choose which cookbook version you want to run in an environment.</p>

<p>In my view Environment JSON file must be kept simple. </p>

<p>If there are some attributes that differs between environments and common across environment, declare them in environment.json file.</p>

<p>If there are some attributes common across environments, create a common role with the attributes and add to other application roles.</p>

<p>If you have different roles with some common attributes and you want to override some of them, use override attribute in environment.json.</p>

<p>When look at the attributes, its just the predecende of default &amp; override attributes that matters with the hierarchy of attribute value. But it could be very complex and easy at the same time if not defined at the right place, something i will have to share in some time.</p>

<p><strong>Where Not to Use Environment JSON attributes</strong></p>

<p>It is very hard to put it in simple words without understanding the requirement of hierarchy flow and cookbooks design. </p>

<p>Environment.json file is a very good place to make global changes to  override attributes or to define default attributes. This is something varies from one setup to another.</p>

<p><strong>Environment with a Common Role</strong></p>

<p>A Common role has simplified managing cookbooks, roles and environments.</p>

<p>Lets say that we have create a common role which will be attached to every other role a node will get associated with.</p>

<p>Any attribute you want to declare across environments, roles or cookbooks can be defined here, e.g. common packages, services, attributes etc., we can declare them in a common role. e.g. role[system]</p>

<h2>
<a name="chef-roles" class="anchor" href="#chef-roles"><span class="octicon octicon-link"></span></a>Chef Roles</h2>

<p>Chef Role is a place to store the attributes for a specific application/role and to define run_list for different environments.</p>

<ul>
<li>is a simple json file or a chef dsl .rb file</li>
<li>a role defined run list for different environment. run_list can be list of other roles or recipes</li>
<li>it stores attributes required for recipes</li>
<li>you can have difference run_list for different environment, run_list is default run_list for _default environment.</li>
</ul><p>For more information on role "<a href="http://docs.opscode.com/essentials_roles.html">http://docs.opscode.com/essentials_roles.html</a>".</p>

<div class="highlight highlight-sh"><pre><span class="c"># cat jump.json</span>

<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"jump"</span>,
  <span class="s2">"description"</span>: <span class="s2">"Jump / SSH Login Gateway Server"</span>,
  <span class="s2">"json_class"</span>: <span class="s2">"Chef::Role"</span>,
  <span class="s2">"default_attributes"</span>: <span class="o">{</span>
    <span class="s2">"groups"</span>: <span class="o">{</span>
      <span class="s2">"dev"</span>: <span class="o">{}</span>
    <span class="o">}</span>,
    <span class="s2">"packages"</span>: <span class="o">{</span>
      <span class="s2">"debian"</span>: <span class="o">{}</span>,
      <span class="s2">"rhel"</span>: <span class="o">{}</span>
    <span class="o">}</span>,
    <span class="s2">"services"</span>: <span class="o">{</span>
      <span class="s2">"rhel"</span>: <span class="o">{}</span>,
      <span class="s2">"debian"</span>: <span class="o">{}</span>
    <span class="o">}</span>
  <span class="o">}</span>,
  <span class="s2">"override_attributes"</span>: <span class="o">{}</span>,
  <span class="s2">"chef_type"</span>: <span class="s2">"role"</span>,
  <span class="s2">"run_list"</span>: <span class="o">[]</span>,
  <span class="s2">"env_run_lists"</span>: <span class="o">{</span>
    <span class="s2">"production"</span>: <span class="o">[</span>
      <span class="s2">"recipe[sshd]"</span>,
      <span class="s2">"role[system]"</span>
    <span class="o">]</span>,
    <span class="s2">"development"</span>: <span class="o">[</span>
      <span class="s2">"recipe[sshd]"</span>,
      <span class="s2">"role[system]"</span>,
      <span class="s2">"role[dev_recipe]"</span>
    <span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p><strong>Common Role - role[system] for all Environments/Nodes</strong></p>

<p>role[system] is a role i have created and including to every another role or run_list of a node. </p>

<p>It is a default role which has all the minimum packages, services, users, file or any other resource which must goes to every node regardless of node environment.</p>

<p>Just adding role[system] to run_lits of other roles we will have our common base setup across the environemnts nodes.</p>

<p><strong>Create a Role</strong></p>

<p>To create a role first time use knife and store the role to a json file as a reference to create more roles or to make changes to a role. </p>

<div class="highlight highlight-sh"><pre>knife role create &lt;role name&gt;
</pre></div>

<p>This way we can put the roles json files into git repo. Like environments json file we can use git to have version controlled on roles json files.</p>

<p>Once a role json file is stored in a git repo, make the changes to role json file and upload to Chef server using knife:</p>

<div class="highlight highlight-sh"><pre>knife role from file role.json
</pre></div>

<h2>
<a name="chef-data-bags" class="anchor" href="#chef-data-bags"><span class="octicon octicon-link"></span></a>Chef Data Bags</h2>

<p>Chef Data Bags are JSON Data Stroes globally available for cookbooks. Data Bag is a immutable data store, primarily useful to store static data information. It also supports encryption to store data bag json file in encrypted format.</p>

<p>Data bag can be created as a chef dsl .rb file or a .json file.</p>

<p>For more information read out "<a href="http://docs.opscode.com/essentials_data_bags.html">http://docs.opscode.com/essentials_data_bags.html</a>".</p>

<h2>
<a name="chef-cookbooks--recipes" class="anchor" href="#chef-cookbooks--recipes"><span class="octicon octicon-link"></span></a>Chef Cookbooks / Recipes</h2>

<p>Cookbook is collection of recipes, attributes, tempaltes etc. Cookbook is like Chef Ruby module to declare resources.</p>

<p><strong>Create Data Bag</strong></p>

<p>A Data Bag or Data Bag Item can be created usin knife:</p>

<div class="highlight highlight-sh"><pre>knife data bag create &lt;data bag name&gt;
knife data bag create &lt;data bag name&gt; &lt;data bag item&gt;
</pre></div>

<p>Create a json file from first data bag item and store it in git. Later it can be used to create an item and upload directly to Chef server.</p>

<p>I found it very convenient to just create a data bag first using knife and later create json file manually or replciate-modify an existing one.</p>

<div class="highlight highlight-sh"><pre>knife data bag from file &lt;data bag name&gt; &lt;data bag item&gt;.json
</pre></div>

<p>Now the data bag is a directory in git repo with different data bag item json files in it.</p>

<h2>
<a name="git-version-controlled---chef-repositories" class="anchor" href="#git-version-controlled---chef-repositories"><span class="octicon octicon-link"></span></a>Git Version Controlled - Chef Repositories</h2>

<p>Git Versioning.</p>

<h2>
<a name="how-does-my-environment-role-data-bags--cookbooks-looks-like" class="anchor" href="#how-does-my-environment-role-data-bags--cookbooks-looks-like"><span class="octicon octicon-link"></span></a>How does my Environment, Role, Data Bags &amp; Cookbooks looks like?</h2>

<p>Apart from the usual setup, I tried to make everything configurable by JSON attributes. So that updating cookbook is not required to add package/service/user etc. </p>

<p>To achieve this i had to modify some of the global opscode recipes.</p>

<p>This may not sound sane but it really saved us time to add services/packages/users etc. </p>

<h2>
<a name="references" class="anchor" href="#references"><span class="octicon octicon-link"></span></a>References:</h2>

<p>OpsCode
Limburge</p>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>Apache v2.0</p>

<p><strong>Open Source, Hell Yeah!</strong></p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>